name: Deploy HubSpot Marketplace App

on:
  push:
    branches:
      - main

env:
  # Official action reads these; use your existing secrets (PORTAL_ID = account ID)
  DEFAULT_ACCOUNT_ID: ${{ secrets.PORTAL_ID }}
  DEFAULT_PERSONAL_ACCESS_KEY: ${{ secrets.HUBSPOT_ACCESS_TOKEN }}
  # Use CLI v7: v8 with --use-env treats PAK as OAuth refresh token and fails
  DEFAULT_CLI_VERSION: "7"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check secrets
        run: |
          if [ -z "${{ secrets.HUBSPOT_ACCESS_TOKEN }}" ]; then echo "::error::HUBSPOT_ACCESS_TOKEN secret is not set"; exit 1; fi
          if [ -z "${{ secrets.PORTAL_ID }}" ]; then echo "::error::PORTAL_ID secret is not set"; exit 1; fi

      - name: HubSpot Project Upload
        uses: HubSpot/hubspot-project-actions/project-upload@v1.1.0
        with:
          debug: true
